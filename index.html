<!-- ※省略部分あり、前回と同じヘッダーやスタイル -->

<script>
let canvases = [];
let historyMap = new Map();
const boxCount = 6;
const templateImages = [
  'https://your-github-repo.github.io/assets/template1.png',
  'https://your-github-repo.github.io/assets/template2.png',
  'https://your-github-repo.github.io/assets/template3.png'
];
let currentCanvasIdForTemplate = null;

function createBoxes() {
  const container = document.getElementById('container');
  container.innerHTML = '';
  canvases = [];

  for (let i = 0; i < boxCount; i++) {
    // 省略：wrapper作成などの前半処理

    const fabricCanvas = new fabric.Canvas(canvasEl.id, {
      selection: false,
      preserveObjectStacking: true
    });
    canvases.push(fabricCanvas);
    saveState(fabricCanvas);

    // ✅ ★ここに重なった画像の選択切り替え処理を追加
    fabricCanvas.on('mouse:down', function(opt) {
      canvases.forEach(c => {
        if (c !== fabricCanvas) {
          c.discardActiveObject();
          c.requestRenderAll();
        }
      });

      if (opt.target) {
        const active = fabricCanvas.getActiveObject();
        const objs = fabricCanvas.getObjects();
        const idx = objs.indexOf(opt.target);

        if (active === opt.target) {
          // 同じ画像を連続でタップ → 下の画像を探す
          const next = objs.slice(0, idx).reverse().find(o => o.selectable);
          if (next) {
            fabricCanvas.setActiveObject(next);
            next.bringToFront();
          }
        } else {
          fabricCanvas.setActiveObject(opt.target);
          opt.target.bringToFront();
        }
        fabricCanvas.requestRenderAll();
      }
    });

    fabricCanvas.on('touch:gesture', function(opt) {
      const obj = fabricCanvas.getActiveObject();
      if (opt.e.touches && opt.e.touches.length === 2 && obj) {
        const scale = opt.e.scale;
        obj.scaleX *= scale;
        obj.scaleY *= scale;
        fabricCanvas.requestRenderAll();
        saveState(fabricCanvas);
      }
      opt.e.preventDefault();
    });
  }
}

// 以下、handleFileSelect / showTemplateSelector / insertTemplateImage / saveImage / saveState / undo / redo / confirmReset などは前回と同じでOK

createBoxes();
</script>
