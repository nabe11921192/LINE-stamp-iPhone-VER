
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>画像エディタ - 重複画像・コピー修正</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0;
      font-family: sans-serif;
      background: #f0f0f0;
      touch-action: manipulation;
    }
    .container { display: flex; flex-direction: column; align-items: center; padding: 10px; }
    .box { width: 370px; height: 320px; background: white; border: 1px solid #ccc; overflow: hidden; }
    #layerPanel {
      display: flex; gap: 8px; margin: 10px 0; padding: 6px;
      border: 1px solid #aaa; background: rgba(255,255,255,0.95); overflow-x: auto;
    }
    .layer-thumb {
      width: 60px; height: 60px;
      border: 2px solid gray;
      object-fit: cover;
      cursor: grab;
      user-select: none;
      touch-action: none;
      background: white;
    }
    .layer-thumb.active { border: 2px solid red; }
    .sortable-ghost { border: 2px dashed #999; background: #ddd; }
    .top-controls, .controls {
      margin-top: 10px; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;
    }
    input[type="file"] { display: none; }
  </style>
</head>
<body>
<div class="container">
  <div class="box"><canvas id="canvas0" width="370" height="320"></canvas></div>
  <div id="layerPanel"></div>
  <div class="top-controls">
    <label style="background:#ccc;padding:8px 16px;border-radius:4px;cursor:pointer;">
      画像選択<input type="file" id="imgInput" accept="image/*" multiple>
    </label>
    <button onclick="showTemplateSelector()">テンプレ</button>
    <button onclick="copyActiveObject()">コピー</button>
    <button onclick="deleteActiveObject()">削除</button>
  </div>
  <div class="controls">
    <button onclick="undo()">戻る</button>
    <button onclick="redo()">進む</button>
    <button onclick="saveImage()">保存</button>
    <button onclick="resetCanvas()">リセット</button>
  </div>
</div>
<div class="template-modal" id="templateModal"></div>

<script>
const canvas = new fabric.Canvas('canvas0', {
  preserveObjectStacking: true,
  selection: true
});
let layers = [];
let history = [];

function saveState() {
  history.push(JSON.stringify(canvas));
}

function undo() {
  if (history.length > 1) {
    history.pop();
    canvas.loadFromJSON(history[history.length - 1], () => canvas.renderAll());
  }
}

function redo() {
  // optional: implement redo stack
}

function addImageToCanvas(img, src) {
  const scale = Math.min(370 / img.width, 320 / img.height);
  img.set({ left: 0, top: 0, scaleX: scale, scaleY: scale, selectable: true });
  canvas.add(img);
  layers.push(img);
  addLayerThumb(img, src);
  canvas.setActiveObject(img);
  saveState();
  canvas.requestRenderAll();
}

function handleFileSelect(files) {
  [...files].forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      const dataURL = e.target.result + '?' + new Date().getTime(); // force unique
      fabric.Image.fromURL(dataURL, img => addImageToCanvas(img, dataURL));
    };
    reader.readAsDataURL(file);
  });
}

document.getElementById('imgInput').addEventListener('change', e => handleFileSelect(e.target.files));

function addLayerThumb(obj, src) {
  const thumb = document.createElement('img');
  thumb.src = src;
  thumb.className = 'layer-thumb';
  thumb.ondragstart = e => e.preventDefault();
  thumb.ontouchstart = e => e.preventDefault();
  thumb.onclick = () => {
    layers.forEach(o => o.selectable = false);
    obj.selectable = true;
    canvas.setActiveObject(obj);
    document.querySelectorAll('.layer-thumb').forEach(t => t.classList.remove('active'));
    thumb.classList.add('active');
    canvas.requestRenderAll();
  };
  document.getElementById('layerPanel').appendChild(thumb);
}

new Sortable(layerPanel, {
  animation: 150,
  ghostClass: 'sortable-ghost',
  onEnd: () => {
    const newOrder = Array.from(document.querySelectorAll('.layer-thumb'));
    layers = newOrder.map(el => layers.find(o => o._element && el.src.includes(o._element.src)));
    canvas.clear();
    layers.forEach(o => canvas.add(o));
    canvas.requestRenderAll();
  }
});

function copyActiveObject() {
  const active = canvas.getActiveObject();
  if (active) {
    active.clone(clone => {
      clone.set({ left: active.left + 10, top: active.top + 10 });
      fabric.util.loadImage(clone._element.src, (img) => {
        const newImg = new fabric.Image(img, {
          left: clone.left,
          top: clone.top,
          scaleX: clone.scaleX,
          scaleY: clone.scaleY,
          selectable: true
        });
        addImageToCanvas(newImg, clone._element.src + '?' + new Date().getTime());
      });
    });
  }
}

function deleteActiveObject() {
  const obj = canvas.getActiveObject();
  if (!obj) return;
  canvas.remove(obj);
  layers = layers.filter(o => o !== obj);
  const thumbs = document.querySelectorAll('.layer-thumb');
  thumbs.forEach(t => {
    if (obj._element && t.src.includes(obj._element.src)) t.remove();
  });
  saveState();
  canvas.requestRenderAll();
}

function saveImage() {
  canvas.discardActiveObject();
  canvas.renderAll();
  canvas.getElement().toBlob(blob => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'output.png';
    a.click();
  }, 'image/png');
}

function resetCanvas() {
  if (confirm('すべての画像を削除しますか？')) {
    canvas.clear();
    layers = [];
    document.getElementById('layerPanel').innerHTML = '';
    saveState();
  }
}

function showTemplateSelector() {
  const modal = document.getElementById('templateModal');
  const templates = [
    "https://nabe11921192.github.io/assets/template1.png",
    "https://nabe11921192.github.io/assets/template2.png",
    "https://nabe11921192.github.io/assets/template3.png"
  ];
  modal.innerHTML = '';
  templates.forEach(src => {
    const img = document.createElement('img');
    img.src = src;
    img.onclick = () => {
      fabric.Image.fromURL(src + '?' + new Date().getTime(), imgObj => addImageToCanvas(imgObj, src));
      modal.style.display = 'none';
    };
    modal.appendChild(img);
  });
  modal.style.display = 'flex';
}

saveState();
</script>
</body>
</html>
